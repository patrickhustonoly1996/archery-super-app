<!DOCTYPE html>
<html>
<head>
  <base href="$FLUTTER_BASE_HREF">

  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta content="IE=Edge" http-equiv="X-UA-Compatible">
  <meta name="description" content="Archery Super App - Training companion for archers">

  <!-- iOS PWA meta tags -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Archery">
  <link rel="apple-touch-icon" href="icons/Icon-192.png">
  <link rel="apple-touch-icon" sizes="180x180" href="icons/Icon-192.png">
  <link rel="apple-touch-icon" sizes="152x152" href="icons/Icon-192.png">
  <link rel="apple-touch-icon" sizes="167x167" href="icons/Icon-192.png">

  <!-- iOS Splash Screens - uses a simple dark background with centered content -->
  <meta name="apple-mobile-web-app-orientations" content="portrait">

  <!-- Android/Chrome PWA -->
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#1a1a1a">

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="favicon.png"/>

  <!-- Preload fonts for splash screen -->
  <link rel="preload" href="assets/fonts/VT323-Regular.ttf" as="font" type="font/ttf" crossorigin>
  <link rel="preload" href="assets/fonts/ShareTechMono-Regular.ttf" as="font" type="font/ttf" crossorigin>

  <title>Archery Super App</title>
  <link rel="manifest" href="manifest.json">

  <!-- Cache busting version - updated by build script -->
  <meta name="app-version" content="__APP_VERSION__">

  <style>
    /* Fonts for splash screen */
    @font-face {
      font-family: 'VT323';
      src: url('assets/fonts/VT323-Regular.ttf') format('truetype');
      font-display: swap;
    }
    @font-face {
      font-family: 'Share Tech Mono';
      src: url('assets/fonts/ShareTechMono-Regular.ttf') format('truetype');
      font-display: swap;
    }

    /* Prevent flash of white during load */
    html, body {
      background-color: #1a1a1a;
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
    }

    /* Loading splash screen */
    #loading-splash {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #1a1a1a;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 999999;
    }
    #loading-splash.hidden {
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease-out;
    }
    .loading-logo {
      width: 100px;
      height: 100px;
      margin-bottom: 16px;
      filter: drop-shadow(0 0 30px rgba(255, 215, 0, 0.6)) drop-shadow(0 0 60px rgba(255, 215, 0, 0.3));
    }
    .loading-title {
      font-family: 'VT323', monospace;
      font-size: 42px;
      color: #FFD700;
      margin-bottom: 8px;
      letter-spacing: 10px;
      text-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
    }
    .loading-subtitle {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 32px;
    }
    .loading-subtitle-square {
      width: 8px;
      height: 8px;
      background: #FFD700;
    }
    .loading-subtitle-line {
      width: 40px;
      height: 2px;
      background: rgba(255, 215, 0, 0.5);
    }
    .loading-subtitle-text {
      font-family: 'VT323', monospace;
      font-size: 16px;
      color: rgba(255, 215, 0, 0.8);
      letter-spacing: 6px;
    }
    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid #333;
      border-top-color: #FFD700;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .loading-text {
      font-family: 'Share Tech Mono', monospace;
      font-size: 14px;
      color: #666;
      margin-top: 16px;
    }
    /* iOS safe area - handled by Flutter's SafeArea widget, not CSS */
    /* DO NOT add padding here - it breaks touch detection in PWA standalone mode */
    /* Update notification banner */
    #update-banner {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: linear-gradient(90deg, #FFD700, #FFA500);
      color: #1a1a1a;
      padding: 12px 16px;
      text-align: center;
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      font-size: 14px;
      font-weight: 600;
      z-index: 999999;
      cursor: pointer;
      padding-top: calc(12px + env(safe-area-inset-top));
    }
    #update-banner:hover {
      background: linear-gradient(90deg, #FFA500, #FF8C00);
    }
    /* Install prompt */
    #install-prompt {
      display: none;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: #2a2a2a;
      color: #fff;
      padding: 16px;
      padding-bottom: calc(16px + env(safe-area-inset-bottom));
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      z-index: 999998;
      border-top: 1px solid #FFD700;
    }
    #install-prompt .install-content {
      max-width: 400px;
      margin: 0 auto;
    }
    #install-prompt h3 {
      margin: 0 0 8px 0;
      font-size: 16px;
      color: #FFD700;
    }
    #install-prompt p {
      margin: 0 0 12px 0;
      font-size: 14px;
      color: #ccc;
      line-height: 1.4;
    }
    #install-prompt .install-steps {
      font-size: 13px;
      color: #aaa;
    }
    #install-prompt .install-btn {
      background: #FFD700;
      color: #1a1a1a;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      margin-right: 8px;
    }
    #install-prompt .dismiss-btn {
      background: transparent;
      color: #888;
      border: 1px solid #444;
      padding: 10px 16px;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
    }
    #install-prompt .btn-row {
      margin-top: 12px;
    }
  </style>
</head>
<body>
  <!-- Loading splash screen - shows immediately while Flutter loads -->
  <div id="loading-splash">
    <img src="icons/Icon-192.png" alt="Logo" class="loading-logo">
    <div class="loading-title">ARCHERY SUPER APP</div>
    <div class="loading-spinner"></div>
    <div class="loading-text">Loading...</div>
  </div>

  <!-- Update notification banner -->
  <div id="update-banner" onclick="location.reload(true)">
    New version available! Tap to update.
  </div>

  <!-- Install prompt for browser users -->
  <div id="install-prompt">
    <div class="install-content">
      <h3>Install Archery App</h3>
      <p id="install-instructions"></p>
      <div class="btn-row">
        <button class="install-btn" id="install-btn" style="display:none;">Install</button>
        <button class="dismiss-btn" onclick="dismissInstall()">Not now</button>
      </div>
    </div>
  </div>

  <script>
    // Install prompt handling
    let deferredPrompt = null;
    const isStandalone = window.matchMedia('(display-mode: standalone)').matches
                      || window.navigator.standalone === true
                      || document.referrer.includes('android-app://');
    const installDismissed = localStorage.getItem('install-dismissed');

    function showInstallPrompt() {
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
      const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
      const instructions = document.getElementById('install-instructions');
      const installBtn = document.getElementById('install-btn');

      if (isIOS) {
        instructions.innerHTML = 'Tap the <strong>Share</strong> button below, then <strong>"Add to Home Screen"</strong> to install as an app.';
      } else if (deferredPrompt) {
        instructions.textContent = 'Install for quick access and a full-screen experience.';
        installBtn.style.display = 'inline-block';
        installBtn.onclick = async () => {
          deferredPrompt.prompt();
          const { outcome } = await deferredPrompt.userChoice;
          if (outcome === 'accepted') {
            document.getElementById('install-prompt').style.display = 'none';
          }
          deferredPrompt = null;
        };
      } else {
        instructions.innerHTML = 'Use your browser menu to <strong>"Install"</strong> or <strong>"Add to Home Screen"</strong> for the best experience.';
      }

      document.getElementById('install-prompt').style.display = 'block';
    }

    function dismissInstall() {
      document.getElementById('install-prompt').style.display = 'none';
      localStorage.setItem('install-dismissed', Date.now());
    }

    // Capture the install prompt for Android/Chrome
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      if (!isStandalone && !installDismissed) {
        showInstallPrompt();
      }
    });

    // Show install prompt after app loads (if not already installed)
    window.addEventListener('load', () => {
      if (!isStandalone && !installDismissed) {
        // Delay showing prompt to let the app load first
        setTimeout(() => {
          if (!deferredPrompt) { // iOS or other browsers without beforeinstallprompt
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
            if (isIOS) {
              showInstallPrompt();
            }
          }
        }, 3000);
      }
    });

    // Service Worker Registration with Update Handling
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', async function() {
        try {
          const registration = await navigator.serviceWorker.register('flutter_service_worker.js');

          // Check for updates immediately
          registration.update();

          // Check for updates every 60 seconds while app is open
          setInterval(() => registration.update(), 60000);

          // Handle update found
          registration.addEventListener('updatefound', () => {
            const newWorker = registration.installing;
            if (newWorker) {
              newWorker.addEventListener('statechange', () => {
                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                  // New version available - show update banner
                  document.getElementById('update-banner').style.display = 'block';

                  // Tell the new service worker to take over immediately
                  newWorker.postMessage('skipWaiting');
                }
              });
            }
          });

          // When controller changes (new SW activated), reload
          let refreshing = false;
          navigator.serviceWorker.addEventListener('controllerchange', () => {
            if (!refreshing) {
              refreshing = true;
              window.location.reload(true);
            }
          });

        } catch (error) {
          console.error('Service Worker registration failed:', error);
        }
      });
    }
  </script>

  <script src="flutter_bootstrap.js" async></script>
  <script>
    // Hide splash screen when Flutter app is ready
    function hideSplash() {
      const splash = document.getElementById('loading-splash');
      if (splash) {
        splash.classList.add('hidden');
        setTimeout(() => splash.remove(), 300);
      }
    }

    window.addEventListener('flutter-first-frame', hideSplash);

    // Fallback: force remove splash after 5 seconds in case event doesn't fire (PWA issue)
    setTimeout(function() {
      const splash = document.getElementById('loading-splash');
      if (splash && !splash.classList.contains('hidden')) {
        console.warn('Flutter first-frame event not received after 5s, forcing splash removal');
        hideSplash();
      }
    }, 5000);
  </script>
</body>
</html>
