<!DOCTYPE html>
<html>
<head>
  <base href="$FLUTTER_BASE_HREF">

  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta content="IE=Edge" http-equiv="X-UA-Compatible">
  <meta name="description" content="Archery Super App - Training companion for archers">

  <!-- iOS PWA meta tags -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Archery">
  <link rel="apple-touch-icon" href="icons/Icon-192.png">
  <link rel="apple-touch-icon" sizes="180x180" href="icons/Icon-192.png">
  <link rel="apple-touch-icon" sizes="152x152" href="icons/Icon-192.png">
  <link rel="apple-touch-icon" sizes="167x167" href="icons/Icon-192.png">

  <!-- iOS Splash Screens - uses a simple dark background with centered content -->
  <meta name="apple-mobile-web-app-orientations" content="portrait">

  <!-- Android/Chrome PWA -->
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#1a1a1a">

  <!-- Favicon -->
  <link rel="icon" type="image/svg+xml" href="favicon.svg"/>
  <link rel="icon" type="image/png" href="favicon.png"/>

  <!-- Preload fonts for splash screen -->
  <link rel="preload" href="assets/fonts/VT323-Regular.ttf" as="font" type="font/ttf" crossorigin>
  <link rel="preload" href="assets/fonts/ShareTechMono-Regular.ttf" as="font" type="font/ttf" crossorigin>

  <title>Archery Super App</title>
  <link rel="manifest" href="manifest.json">

  <!-- Cache busting version - updated by build script -->
  <meta name="app-version" content="__APP_VERSION__">

  <style>
    /* Fonts for splash screen */
    @font-face {
      font-family: 'VT323';
      src: url('assets/fonts/VT323-Regular.ttf') format('truetype');
      font-display: swap;
    }
    @font-face {
      font-family: 'Share Tech Mono';
      src: url('assets/fonts/ShareTechMono-Regular.ttf') format('truetype');
      font-display: swap;
    }

    /* Prevent flash of white/grey during load - critical for Android PWA */
    html, body {
      background-color: #1a1a1a;
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
      /* Force dark background even if CSS partially loads */
      color-scheme: dark;
    }

    /* Ensure Flutter container never shows grey/white */
    flt-glass-pane, flt-scene-host, flutter-view {
      background-color: #1a1a1a !important;
    }

    /* Eliminate iOS 300ms touch delay for all interactive elements */
    * {
      touch-action: manipulation;
    }

    /* Loading splash screen */
    #loading-splash {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #1a1a1a;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 999999;
    }
    #loading-splash.hidden {
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease-out;
    }
    .loading-logo {
      width: 100px;
      height: 100px;
      margin-bottom: 16px;
      filter: drop-shadow(0 0 30px rgba(255, 215, 0, 0.6)) drop-shadow(0 0 60px rgba(255, 215, 0, 0.3));
    }
    .loading-title {
      font-family: 'VT323', monospace;
      font-size: 42px;
      color: #FFD700;
      margin-bottom: 8px;
      letter-spacing: 10px;
      text-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
    }
    .loading-subtitle {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 32px;
    }
    .loading-subtitle-square {
      width: 8px;
      height: 8px;
      background: #FFD700;
    }
    .loading-subtitle-line {
      width: 40px;
      height: 2px;
      background: rgba(255, 215, 0, 0.5);
    }
    .loading-subtitle-text {
      font-family: 'VT323', monospace;
      font-size: 16px;
      color: rgba(255, 215, 0, 0.8);
      letter-spacing: 6px;
    }
    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid #333;
      border-top-color: #FFD700;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .loading-text {
      font-family: 'Share Tech Mono', monospace;
      font-size: 14px;
      color: #666;
      margin-top: 16px;
    }
    .loading-retry {
      display: none;
      font-family: 'Share Tech Mono', monospace;
      font-size: 14px;
      color: #FFD700;
      margin-top: 24px;
      padding: 12px 24px;
      border: 1px solid #FFD700;
      background: transparent;
      cursor: pointer;
    }
    .loading-retry:hover {
      background: rgba(255, 215, 0, 0.1);
    }
    /* iOS safe area - handled by Flutter's SafeArea widget, not CSS */
    /* DO NOT add padding here - it breaks touch detection in PWA standalone mode */
    /* Install prompt */
    #install-prompt {
      display: none;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: #2a2a2a;
      color: #fff;
      padding: 16px;
      padding-bottom: calc(16px + env(safe-area-inset-bottom));
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      z-index: 999998;
      border-top: 1px solid #FFD700;
    }
    #install-prompt .install-content {
      max-width: 400px;
      margin: 0 auto;
    }
    #install-prompt h3 {
      margin: 0 0 8px 0;
      font-size: 16px;
      color: #FFD700;
    }
    #install-prompt p {
      margin: 0 0 12px 0;
      font-size: 14px;
      color: #ccc;
      line-height: 1.4;
    }
    #install-prompt .install-steps {
      font-size: 13px;
      color: #aaa;
    }
    #install-prompt .install-btn {
      background: #FFD700;
      color: #1a1a1a;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      margin-right: 8px;
    }
    #install-prompt .dismiss-btn {
      background: transparent;
      color: #888;
      border: 1px solid #444;
      padding: 10px 16px;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
    }
    #install-prompt .btn-row {
      margin-top: 12px;
    }
  </style>
</head>
<body>
  <!-- Loading splash screen - shows immediately while Flutter loads -->
  <div id="loading-splash">
    <!-- Pixel arrow SVG - matches PixelBowIcon exactly -->
    <svg class="loading-logo" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
      <!-- Arrow shaft -->
      <rect x="1" y="7" width="11" height="2" fill="#FFD700"/>
      <!-- Arrow head - top -->
      <rect x="9" y="4" width="1" height="1" fill="#FFD700"/>
      <rect x="10" y="5" width="1" height="1" fill="#FFD700"/>
      <rect x="11" y="6" width="1" height="1" fill="#FFD700"/>
      <rect x="12" y="7" width="1" height="2" fill="#FFD700"/>
      <!-- Arrow head - bottom -->
      <rect x="11" y="9" width="1" height="1" fill="#FFD700"/>
      <rect x="10" y="10" width="1" height="1" fill="#FFD700"/>
      <rect x="9" y="11" width="1" height="1" fill="#FFD700"/>
      <!-- Fletching -->
      <rect x="1" y="5" width="1" height="1" fill="rgba(255,215,0,0.5)"/>
      <rect x="2" y="6" width="1" height="1" fill="rgba(255,215,0,0.5)"/>
      <rect x="1" y="10" width="1" height="1" fill="rgba(255,215,0,0.5)"/>
      <rect x="2" y="9" width="1" height="1" fill="rgba(255,215,0,0.5)"/>
      <!-- Nock -->
      <rect x="0" y="7" width="1" height="2" fill="rgba(255,215,0,0.3)"/>
    </svg>
    <div class="loading-title">ARCHERY</div>
    <div class="loading-subtitle">
      <div class="loading-subtitle-square"></div>
      <div class="loading-subtitle-line"></div>
      <div class="loading-subtitle-text">SUPER APP</div>
      <div class="loading-subtitle-line"></div>
      <div class="loading-subtitle-square"></div>
    </div>
    <div class="loading-spinner"></div>
    <div class="loading-text">Loading...</div>
    <button class="loading-retry" onclick="location.reload(true)">Tap to reload</button>
  </div>

  <!-- Install prompt for browser users -->
  <div id="install-prompt">
    <div class="install-content">
      <h3>Install Archery App</h3>
      <p id="install-instructions"></p>
      <div class="btn-row">
        <button class="install-btn" id="install-btn" style="display:none;">Install</button>
        <button class="dismiss-btn" onclick="dismissInstall()">Not now</button>
      </div>
    </div>
  </div>

  <script>
    // Install prompt handling
    let deferredPrompt = null;
    const isStandalone = window.matchMedia('(display-mode: standalone)').matches
                      || window.navigator.standalone === true
                      || document.referrer.includes('android-app://');
    const installDismissed = localStorage.getItem('install-dismissed');

    function showInstallPrompt() {
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
      const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
      const instructions = document.getElementById('install-instructions');
      const installBtn = document.getElementById('install-btn');

      if (isIOS) {
        instructions.innerHTML = 'Tap the <strong>Share</strong> button below, then <strong>"Add to Home Screen"</strong> to install as an app.';
      } else if (deferredPrompt) {
        instructions.textContent = 'Install for quick access and a full-screen experience.';
        installBtn.style.display = 'inline-block';
        installBtn.onclick = async () => {
          deferredPrompt.prompt();
          const { outcome } = await deferredPrompt.userChoice;
          if (outcome === 'accepted') {
            document.getElementById('install-prompt').style.display = 'none';
          }
          deferredPrompt = null;
        };
      } else {
        instructions.innerHTML = 'Use your browser menu to <strong>"Install"</strong> or <strong>"Add to Home Screen"</strong> for the best experience.';
      }

      document.getElementById('install-prompt').style.display = 'block';
    }

    function dismissInstall() {
      document.getElementById('install-prompt').style.display = 'none';
      localStorage.setItem('install-dismissed', Date.now());
    }

    // Capture the install prompt for Android/Chrome
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      if (!isStandalone && !installDismissed) {
        showInstallPrompt();
      }
    });

    // Show install prompt after app loads (if not already installed)
    window.addEventListener('load', () => {
      if (!isStandalone && !installDismissed) {
        // Delay showing prompt to let the app load first
        setTimeout(() => {
          if (!deferredPrompt) { // iOS or other browsers without beforeinstallprompt
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
            if (isIOS) {
              showInstallPrompt();
            }
          }
        }, 3000);
      }
    });

    // Service Worker Registration with Update Handling
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', async function() {
        try {
          const registration = await navigator.serviceWorker.register('flutter_service_worker.js');

          // Check for updates once on app open - that's enough
          // No polling: offline-first means the app works without network
          registration.update();

          // Handle update found - force update immediately
          registration.addEventListener('updatefound', () => {
            const newWorker = registration.installing;
            if (newWorker) {
              newWorker.addEventListener('statechange', () => {
                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                  // New version ready - activate it immediately
                  newWorker.postMessage('skipWaiting');
                }
              });
            }
          });

          // When controller changes (new SW activated), reload
          let refreshing = false;
          navigator.serviceWorker.addEventListener('controllerchange', () => {
            if (!refreshing) {
              refreshing = true;
              window.location.reload(true);
            }
          });

        } catch (error) {
          console.error('Service Worker registration failed:', error);
        }
      });
    }
  </script>

  <script src="flutter_bootstrap.js" async></script>
  <script>
    // Hide splash screen when Flutter app is ready
    function hideSplash() {
      const splash = document.getElementById('loading-splash');
      if (splash) {
        splash.classList.add('hidden');
        setTimeout(() => splash.remove(), 300);
      }
    }

    window.addEventListener('flutter-first-frame', hideSplash);

    // Fallback: force remove splash after 5 seconds in case event doesn't fire (PWA issue)
    setTimeout(function() {
      const splash = document.getElementById('loading-splash');
      if (splash && !splash.classList.contains('hidden')) {
        console.warn('Flutter first-frame event not received after 5s, forcing splash removal');
        hideSplash();
      }
    }, 5000);

    // Emergency fallback: if splash is STILL visible after 15 seconds, show reload button
    // This handles cases where Flutter completely fails to initialize (grey screen issue)
    setTimeout(function() {
      const splash = document.getElementById('loading-splash');
      if (splash && !splash.classList.contains('hidden')) {
        console.warn('Flutter still not loaded after 15s, showing reload option');
        const retryBtn = splash.querySelector('.loading-retry');
        const loadingText = splash.querySelector('.loading-text');
        if (retryBtn) retryBtn.style.display = 'block';
        if (loadingText) loadingText.textContent = 'Taking too long...';
      }
    }, 15000);

    // Android PWA resume fix: when app returns from background, ensure splash is gone
    // Android can kill/reload PWA while suspended, causing splash to reappear without
    // the flutter-first-frame event firing again
    document.addEventListener('visibilitychange', function() {
      if (document.visibilityState === 'visible') {
        // Give Flutter a moment to re-render after resume
        setTimeout(function() {
          const splash = document.getElementById('loading-splash');
          if (splash && !splash.classList.contains('hidden')) {
            console.warn('Splash still visible after resume, forcing removal');
            hideSplash();
          }
        }, 2000);
      }
    });

    // Additional safety: if page was loaded in background (prerender), handle it
    if (document.visibilityState === 'hidden') {
      document.addEventListener('visibilitychange', function onFirstVisible() {
        if (document.visibilityState === 'visible') {
          document.removeEventListener('visibilitychange', onFirstVisible);
          setTimeout(function() {
            const splash = document.getElementById('loading-splash');
            if (splash && !splash.classList.contains('hidden')) {
              console.warn('Splash still visible after becoming visible, forcing removal');
              hideSplash();
            }
          }, 5000);
        }
      });
    }
  </script>
</body>
</html>
